apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: dr-trading-api
  namespace: exchange
spec:
  host: svc-trading-api.exchange.svc.cluster.local
  trafficPolicy:
    connectionPool:
      http:
        http1MaxPendingRequests: 1000
        maxRequestsPerConnection: 100
    outlierDetection:
      consecutive5xx: 5
      interval: 5s
      baseEjectionTime: 30s
      maxEjectionPercent: 50
    loadBalancer: { simple: LEAST_REQUEST }
---
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: vs-gateway
  namespace: exchange
spec:
  hosts: ["api.exchange.example.com"]
  gateways: ["public-gateway"]
  http:
    - match: [{ uri: { prefix: "/api/v1/trade" } }]
      retries: { attempts: 2, perTryTimeout: 500ms, retryOn: "5xx,gateway-error,connect-failure,refused-stream" }
      route: [{ destination: { host: svc-trading-api.exchange.svc.cluster.local, port: { number: 8080 }}}]
    - match: [{ uri: { prefix: "/api/v1/wallet" } }]
      retries: { attempts: 2, perTryTimeout: 500ms, retryOn: "5xx,gateway-error,connect-failure,refused-stream" }
      route: [{ destination: { host: svc-wallet.exchange.svc.cluster.local, port: { number: 8080 }}}]
